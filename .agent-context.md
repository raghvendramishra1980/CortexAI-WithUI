# OpenAI Project - Claude Context

## Project Overview
Multi-provider AI chat CLI with token tracking and cost calculation.

## Quick Reference

### Entry Points
- **CLI**: `python main.py` - Interactive chat interface
- **API**: `python run_server.py --reload` - FastAPI server
- **Test API**: `python tests/test_api.py` - API test script
- **Quick Test**: `python quick_test_optimizer.py` - Prompt optimizer example utility

### Providers
- **OpenAI**: `api/openai_client.py` - GPT models
- **Gemini**: `api/google_gemini_client.py` - Google models
- **DeepSeek**: `api/deepseek_client.py` - DeepSeek models
- **Grok**: `api/grok_client.py` - X.AI models

### Key Files
- `main.py` - **Thin CLI layer** (user I/O only)
- `run_server.py` - **FastAPI entry point** (NEW - Jan 2026)
- `quick_test_optimizer.py` - **Quick testing utility** (NEW)
- `pyproject.toml` - **Modern Python packaging** (NEW)
- `orchestrator/core.py` - Core business logic (CortexOrchestrator)
- `models/user_context.py` - Session metadata container
- `server/app.py` - FastAPI app factory (NEW)
- `server/routes/` - API endpoints: health, chat, compare (NEW)
- `server/schemas/` - Pydantic request/response models (NEW)
- `server/middleware.py` - Request ID middleware (NEW)
- `server/dependencies.py` - Auth & orchestrator deps (NEW)
- `db/` - **Database integration layer** (NEW)
- `tools/web/` - **Research tools and web integration** (NEW)
- `utils/token_tracker.py` - Tracks tokens (prompt/completion/total)
- `utils/cost_calculator.py` - Calculates costs (separate from token tracking)
- `utils/prompt_optimizer.py` - **AI-powered prompt optimization** (NEW - Feb 2026)
- `utils/logger.py` - Structured JSON logging system
- `config/pricing.py` - Pricing data for all models
- `.env` - Configuration (API keys, MODEL_TYPE, LOG_LEVEL, API_KEYS)

### Architecture
**Orchestrator Pattern with FastAPI and Database (Updated 2026-02-11)**
```
CLI Layer (main.py)                        ‚Üí User I/O
    ‚Üì
FastAPI Layer (server/)                    ‚Üí HTTP API (auth, validation)
    ‚Üì                                         /health, /v1/chat, /v1/compare
    ‚Üì                                         asyncio.to_thread() wrapper
CortexOrchestrator (orchestrator/core.py)  ‚Üí Business logic (shared)
    ‚Üì
Database Layer (db/)                      ‚Üí Persistent storage (NEW)
    ‚Üì
Research Tools (tools/web/)               ‚Üí Web research capabilities (NEW)
    ‚Üì
BaseAIClient implementations (api/)      ‚Üí Provider-specific calls
    ‚Üì
UnifiedResponse / MultiUnifiedResponse   ‚Üí Standardized responses
```

**Key Components**:
- `orchestrator/core.py` - **CortexOrchestrator** (stateless business logic)
  - `ask(prompt, model_type, context)` - Single model requests
  - `compare(prompt, models_list, context)` - Multi-model comparisons
- `models/user_context.py` - **UserContext** (session metadata container)
- `db/` - **Database integration** (SQLAlchemy-based persistence)
  - `engine.py` - Database engine configuration
  - `repository.py` - Data access layer
  - `session.py` - Session management
  - `tables.py` - Table definitions
- `tools/web/` - **Research tools** (web search and data gathering)
  - `tavily_client.py` - Tavily web search integration
  - `research_decider.py` - Research decision logic
  - `intent.py` - Intent classification
  - `cache.py` - Research caching system
- `utils/prompt_optimizer.py` - **PromptOptimizer** (AI-powered prompt optimization)
  - `optimize_prompt(input_data)` - Optimize user prompts with structured output
  - Multi-stage validation: input ‚Üí AI optimization ‚Üí output validation
  - Self-correction with retry logic and exponential backoff
  - Supports OpenAI and Gemini providers
- All clients inherit from `api/base_client.py::BaseAIClient`
- **UnifiedResponse Contract**: All `get_completion()` methods return `UnifiedResponse` (never raise exceptions)
  - Defined in `models/unified_response.py`
  - Immutable frozen dataclass with: `request_id`, `text`, `provider`, `model`, `latency_ms`, `token_usage`, `estimated_cost`, `finish_reason`, `error`
  - Errors returned as `NormalizedError` inside response (codes: timeout, auth, rate_limit, bad_request, provider_error, unknown)
- TokenTracker and CostCalculator are independent modules
- Pricing stored centrally in `config/pricing.py`

### Common Tasks
- **Start FastAPI**: `python run_server.py --reload`
- **Test API**: `curl http://localhost:8000/health` or `python tests/test_api.py`
- **Quick Test**: `python quick_test_optimizer.py` (prompt optimizer examples)
- **Run CI checks locally**: `ruff check . && black --check . && mypy . --explicit-package-bases && python -m pytest tests -m "not integration"`
- **Add new provider**: Create client in `api/`, add pricing, update `main.py`
- **Update pricing**: Edit `config/pricing.py`
- **Switch model**: Change `MODEL_TYPE` in `.env`
- **API auth**: Add keys to `API_KEYS` in `.env` (comma-separated)
- **Database operations**: Use `db/repository.py` for data access
- **Web research**: Use `tools/web/tavily_client.py` for web search
- **Prompt optimization**: Use `utils/prompt_optimizer.py` for AI-powered prompt improvements

### Current Config
- Active model: Grok (`grok-4-latest`)
- Features: Token tracking, cost calculation, session stats, **structured JSON logging**, **FastAPI REST API**, **database persistence**, **web research tools**, **prompt optimizer**
- CLI Commands: `stats`, `help`, `exit`
- API Endpoints: `/health`, `/v1/chat`, `/v1/compare`
- API Auth: X-API-Key header (keys: dev-key-1, dev-key-2)
- API Guardrails: Context max 10 msgs/8K chars, output max 1024 tokens, compare 2-4 targets
- Logging: Files in `logs/` directory (app.log, error.log, debug.log)
- Database: SQLAlchemy-based persistent storage
- Research: Tavily web search integration with caching
- Prompt Optimizer: AI-powered prompt improvements (OpenAI/Gemini)

## File Purpose Quick Map
```
.env                     ‚Üí Environment configuration (not in git)
.env.example             ‚Üí Configuration template
.gitignore               ‚Üí Git ignore rules
.github/                 ‚Üí GitHub workflows and configuration (NEW)
  ‚îî‚îÄ‚îÄ workflows/
      ‚îî‚îÄ‚îÄ ci.yml         ‚Üí Continuous integration workflow (NEW)
        ‚Üí Ruff linting, Black formatting, MyPy type checking
        ‚Üí Pytest unit tests, pip-audit security scanning
        ‚Üí Gitleaks secrets detection, quality gates
README.md                ‚Üí Project documentation
main.py                  ‚Üí Thin CLI layer (user I/O only)
run_server.py            ‚Üí FastAPI server entry point (NEW)
quick_test_optimizer.py  ‚Üí Prompt optimizer example utility (NEW)
pyproject.toml           ‚Üí Modern Python packaging (NEW)
server/app.py            ‚Üí FastAPI app factory (NEW)
server/routes/health.py  ‚Üí GET /health endpoint (NEW)
server/routes/chat.py    ‚Üí POST /v1/chat endpoint (NEW)
server/routes/compare.py ‚Üí POST /v1/compare endpoint (NEW)
server/schemas/requests.py  ‚Üí Pydantic request models (NEW)
server/schemas/responses.py ‚Üí Pydantic response DTOs (NEW)
server/middleware.py     ‚Üí Request ID middleware (NEW)
server/dependencies.py   ‚Üí Auth & orchestrator deps (NEW)
server/utils.py          ‚Üí Token/cost guardrails (NEW)
orchestrator/core.py     ‚Üí Business logic orchestrator (stateless, shared)
orchestrator/multi_orchestrator.py ‚Üí Multi-model comparison logic
models/user_context.py   ‚Üí Session metadata container
models/unified_response.py ‚Üí Single response model
models/multi_unified_response.py ‚Üí Multi-model response model
db/engine.py             ‚Üí Database engine configuration (NEW)
db/repository.py          ‚Üí Data access layer (NEW)
db/session.py             ‚Üí Database session management (NEW)
db/tables.py             ‚Üí Database table definitions (NEW)
api/base_client.py       ‚Üí Abstract base for all clients
api/*_client.py          ‚Üí Provider-specific implementations
config/pricing.py        ‚Üí Model pricing data (per million tokens)
tools/web/               ‚Üí Research and web tools (NEW)
  ‚îú‚îÄ‚îÄ tavily_client.py   ‚Üí Tavily web search client
  ‚îú‚îÄ‚îÄ research_decider.py ‚Üí Research decision logic
  ‚îú‚îÄ‚îÄ intent.py          ‚Üí Intent classification
  ‚îú‚îÄ‚îÄ cache.py           ‚Üí Research caching
  ‚îî‚îÄ‚îÄ ...                ‚Üí Other research utilities
utils/token_tracker.py   ‚Üí Token counting only
utils/cost_calculator.py ‚Üí Cost calculation only (uses pricing.py)
utils/prompt_optimizer.py ‚Üí AI-powered prompt optimization (NEW)
utils/logger.py          ‚Üí Structured JSON logging (enterprise-ready)
logs/                    ‚Üí Log files (app.log, error.log, debug.log)
docs/                    ‚Üí Documentation (NEW organization)
  ‚îú‚îÄ‚îÄ CHANGELOG.md       ‚Üí Version history
  ‚îú‚îÄ‚îÄ COMPARE_MODE_GUIDE.md ‚Üí Multi-model comparison guide
  ‚îú‚îÄ‚îÄ DATABASE_INTEGRATION_COMPLETE.md ‚Üí Database docs
  ‚îú‚îÄ‚îÄ FASTAPI_README.md  ‚Üí FastAPI documentation
  ‚îú‚îÄ‚îÄ LOGGING.md         ‚Üí Logging documentation
  ‚îú‚îÄ‚îÄ TAVILY_INTEGRATION.md ‚Üí Tavily integration docs
  ‚îî‚îÄ‚îÄ ...                ‚Üí Other documentation
tests/                   ‚Üí Test suite
  ‚îú‚îÄ‚îÄ test_api.py         ‚Üí API test script
  ‚îú‚îÄ‚îÄ test_conversation.py ‚Üí Conversation tests
  ‚îú‚îÄ‚îÄ test_fastapi_contract_and_guardrails.py ‚Üí FastAPI tests
  ‚îî‚îÄ‚îÄ ...                ‚Üí Other tests
```

## Recent Changes
- **üóÑÔ∏è DATABASE INTEGRATION (2026-02-11): Added persistent storage layer**
  - SQLAlchemy-based database integration in `db/`
  - Repository pattern for data access
  - Session management and table definitions
  - Persistent conversation and session storage
- **üîç RESEARCH TOOLS (2026-02-11): Added web research capabilities**
  - Tavily web search integration in `tools/web/`
  - Intent classification and research decision logic
  - Research caching and state management
  - Web data gathering and processing tools
- **‚ú® PROMPT OPTIMIZER (2026-02-11): Added AI-powered prompt optimization**
  - Created `utils/prompt_optimizer.py` with multi-stage validation
  - Supports OpenAI and Google Gemini providers
  - Structured JSON output with optimized_prompt, steps, explanations, metrics
  - Self-correction with retry logic and exponential backoff
  - Comprehensive test suite (20+ tests)
- **üì¶ MODERN PACKAGING (2026-02-11): Updated project structure**
  - Added `pyproject.toml` for modern Python packaging
  - Added `requirements-dev.txt` for development dependencies
  - Added `quick_test_optimizer.py` for prompt optimizer examples
  - Reorganized documentation in `docs/` directory
- **üöÄ CI/CD PIPELINE (2026-02-11): Added comprehensive quality gates**
  - GitHub Actions workflow in `.github/workflows/ci.yml`
  - Ruff linting, Black formatting, MyPy type checking
  - Pytest unit tests (100+ tests), pip-audit security scanning
  - Gitleaks secrets detection
  - Quality gates on push/PR to main/master branches
- **‚ú® FASTAPI GUARDRAILS (2026-01-08): Added token/cost protection**
  - Context limited to 10 messages, 8000 chars (trimmed/rejected)
  - Output capped at 1024 tokens max
  - Compare: requires 2-4 targets, context only allowed with ‚â§2 targets
  - Removed exception masking - provider errors preserved in UnifiedResponse
- **‚ú® FASTAPI INTEGRATION (2026-01-08): Added RESTful HTTP API layer**
  - Created `server/` directory with FastAPI application
  - Routes: `/health`, `/v1/chat`, `/v1/compare`
  - API key auth via `X-API-Key` header
  - Request ID tracking via `X-Request-ID` header
  - Pydantic request/response validation
  - asyncio.to_thread() for sync provider SDKs
  - CLI unchanged and working
  - See `FASTAPI_README.md` for full docs
- **‚ú® MAJOR REFACTOR (2026-01-07): Separated business logic from CLI**
  - Created `orchestrator/core.py` with `CortexOrchestrator` class
  - Created `models/user_context.py` for session metadata
  - Refactored `main.py` to be a thin CLI layer
  - Enables FastAPI, SDK, and other integrations
  - See `REFACTORING_SUMMARY.md` for full details
- Added enterprise-ready structured JSON logging system
  - All logs go to `logs/` directory (console stays clean)
  - JSON format for ELK/Loki/Datadog integration
  - Rotating file handlers (10MB max, 5 backups)
  - Environment-based config (LOG_LEVEL, LOG_TO_CONSOLE)
- Added Grok (X.AI) support
- Implemented cost tracking system
- Separated token tracking from cost calculation

## Design Principles
- **Orchestrator Pattern**: Business logic separated from UI
- **Stateless Design**: All context passed via UserContext
- **Separation of concerns** (tokens ‚â† costs ‚â† logging ‚â† orchestration ‚â† UI ‚â† database ‚â† research ‚â† optimization)
- **Provider-agnostic base client**
- **Environment-based configuration**
- **Real-time cost display per request**
- **Clean console for chat, logs to files**
- **Enterprise-ready logging** (JSON, rotating, structured)
- **Database persistence** for conversations and sessions
- **Web research capabilities** with caching and intent classification
- **AI-powered optimization** with multi-stage validation and self-correction
- **Future-ready** (FastAPI, SDK, gRPC ready)

## Logging System (NEW)
- **Location**: `logs/` directory
- **Format**: Structured JSON for log aggregation
- **Files**: app.log (INFO+), error.log (ERROR+), debug.log (DEBUG, if enabled)
- **Config**: LOG_LEVEL (DEBUG/INFO/WARNING/ERROR/CRITICAL), LOG_TO_CONSOLE (true/false)
- **Rotation**: 10MB max per file, 5 backups
- **Integration**: Ready for ELK Stack, Grafana Loki, Datadog
- **Privacy**: No user messages or API keys logged
