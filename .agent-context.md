# OpenAIProject Agent Context

## Project Snapshot

Multi-provider LLM system with both CLI and FastAPI interfaces.

Providers:
- OpenAI
- Gemini
- DeepSeek
- Grok

Core goals:
- Unified provider contract (`UnifiedResponse`)
- Smart model routing with fallback/escalation
- Optional DB persistence and usage accounting
- Optional web research support

## Entry Points

- CLI: `python main.py`
- API server: `python run_server.py --reload`
- API quick tests (integration): `pytest tests/test_api.py -v`
- All tests: `pytest`
- Non-integration tests: `pytest -m "not integration"`

## Current Architecture

1. Interface layer:
- CLI in `main.py`
- HTTP API in `server/`

2. Business orchestration:
- `orchestrator/core.py` (`CortexOrchestrator`)
- `ask()` for single response
- `compare()` for multi-target response

3. Smart routing pipeline:
- `orchestrator/prompt_analyzer.py`
- `orchestrator/tier_decider.py`
- `orchestrator/model_registry.py`
- `orchestrator/model_selector.py`
- `orchestrator/response_validator.py`
- `orchestrator/fallback_manager.py`
- `orchestrator/smart_router.py`

4. Provider execution:
- `api/openai_client.py`
- `api/google_gemini_client.py`
- `api/deepseek_client.py`
- `api/grok_client.py`

5. Shared models and accounting:
- `models/unified_response.py`
- `utils/token_tracker.py`
- `utils/cost_calculator.py`
- `config/pricing.py`

## Routing and Tiering (Important)

Registry source:
- `config/model_registry.yaml`

Tiers:
- `T0`, `T1`, `T2`, `T3`

Routing modes:
- `smart` -> automatic tier selection
- `cheap` -> force start at `T0`
- `strong` -> force start at `T2`

Selection details:
- Tag-aware ranking (`coding`, `reasoning`, `long_context`, `cheap`, etc.)
- Cost-aware ordering (blended input/output cost)
- Context-limit filtering with token buffer
- Optional `routing_constraints` support (`max_cost_usd`, provider constraints, strict/json hints)

Fallback logic:
- Retries same tier on provider errors/timeouts/rate limits/refusals when candidates remain
- Escalates tier for refusal/format/truncation/quality failures
- Controlled by `max_attempts` and latency budget from `model_registry.yaml`

Validation details:
- Refusal-pattern detection added in `orchestrator/response_validator.py`
- Refusals now trigger fallback/escalation path

## Explicit Model Selection Rules

In `CortexOrchestrator.ask()`:
- If both `provider` and `model` are supplied, routing is bypassed
- Supplied pair is validated against `model_registry.yaml`
- Unknown/disabled model returns structured `bad_request`

If routing mode is not one of `smart|cheap|strong`:
- `provider` is required

## CLI Behavior (Important)

Commands:
- `help`, `stats`, `/paste`, `/end`, `/cancel`, `/reset`, `/history`, `/new`, `/dbstats`, `exit`

Multiline paste:
- `/paste` captures multiple lines until `/end`
- If captured text looks like code and has no clear task intent, CLI auto-prefixes a default review/refactor instruction

Research mode:
- Prompted at startup (`off` or `on`)

Routing debug:
- Set `ROUTING_DEBUG=true` to print routing metadata in CLI responses

## API Behavior (Important)

Routes:
- `GET /health`
- `POST /v1/chat`
- `POST /v1/compare`

Auth:
- Header `X-API-Key`
- Keys from `.env` `API_KEYS`

`/v1/chat` request model:
- `provider` is optional
- supports `routing_mode` and `routing_constraints`

Guardrails in `server/utils.py`:
- Context trimmed to 10 messages
- Context capped at 8000 chars
- `max_tokens` clamped to 1024

`/v1/compare` guardrails:
- 2 to 4 targets
- Context rejected when targets > 2

Known behavior:
- Daily usage cap enforcement (`DAILY_TOKEN_CAP`, `DAILY_COST_CAP`) is implemented in CLI flow with DB enabled.
- API routes do not currently apply those caps.

## Model Discovery Utilities

- `list-models.cmd`
- `list-models.ps1`
- `utils/model_utils.py::ModelUtils.list_all_available_models()`

Notes:
- Lists supported models per provider account/API key.
- Gemini listing falls back to raw model output if `generateContent` capability metadata is missing.

## DB and Persistence

DB package:
- `db/engine.py`
- `db/session.py`
- `db/tables.py`
- `db/repository.py`

CLI DB behavior:
- Resumes active session if present
- Can create new session via `/new`
- Persists requests/responses and updates daily usage

## Test Coverage Highlights

Routing and selector tests:
- `tests/test_routing_regression.py`
- `tests/test_model_selector.py`
- `tests/test_tier_decider.py`
- `tests/test_prompt_analyzer.py`
- `tests/test_response_validator.py`
- `tests/test_fallback_manager.py`

Config alignment:
- `tests/test_registry_pricing_alignment.py`

API contracts:
- `tests/test_fastapi_contract_and_guardrails.py`

Integration:
- `tests/test_api.py` requires running server

## Current Focus Areas

- Keep `config/model_registry.yaml` and `config/pricing.py` aligned
- Preserve explicit model override validation behavior
- Preserve refusal-aware fallback behavior
- Keep README and this file aligned with real project behavior

---

Last updated: 2026-02-16
